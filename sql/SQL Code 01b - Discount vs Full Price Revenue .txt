WITH base_profit AS 
(
    SELECT
        o.order_id,
        o.order_date,
	DATE_TRUNC('month',order_date)::date AS month, 
	TO_CHAR(DATE_TRUNC('month',order_date) ,'YYYY MON') AS month_label,
        o.sales_channel,
        o.order_status,
        c.segment,
        c.region,
        p.category,
        p.subcategory,

        oi.quantity,
        oi.list_price,
        oi.discount_pct,
        oi.net_price,
        oi.line_revenue AS net_revenue, -- real-life name

        -- Real-life cost term
        (oi.quantity * p.unit_cost) AS cogs,

        -- Real-life gross profit
        oi.line_revenue - (oi.quantity * p.unit_cost) AS gross_profit,

        -- Gross margin % is a finance KPI
        ROUND
		(
			(
				(oi.line_revenue - (oi.quantity * p.unit_cost))*100.0 
            			/ 
				NULLIF(oi.line_revenue, 0 )
			)
			,2
		) AS gross_margin_pct,

        -- Price/discount analysis
        (oi.quantity * oi.list_price) AS full_price_revenue,
        (oi.quantity * oi.list_price) - oi.line_revenue AS discount_amount

    FROM orders o
    JOIN order_items oi ON o.order_id = oi.order_id
    JOIN products p     ON oi.product_id = p.product_id
    LEFT JOIN customers c ON o.customer_id = c.customer_id
    WHERE o.order_status = 'Completed'
),

base_profit2 AS
(
	SELECT 
		month,
		month_label,
		SUM
		(
			CASE
				WHEN discount_pct > 0 THEN net_revenue ELSE 0
			END
		)
		AS revenue_disc_price,

		SUM
		(
			CASE
				WHEN discount_pct = 0 THEN net_revenue ELSE 0
			END
		)
		AS revenue_full_price,

		ROUND
		(
			(SUM(discount_amount) * 100.0 / SUM(full_price_revenue)) 
			,2
		) 
		AS discount_rate_pct
	
	FROM base_profit
	GROUP BY month, month_label
	ORDER BY month, month_label
)

SELECT 
	month,
	month_label,
	revenue_disc_price,
	ROUND
	(
		(revenue_disc_price * 100.0 / (revenue_disc_price + revenue_full_price))
		,2
	) AS revenue_disc_price_pct,
	
	revenue_full_price,
	
	ROUND
	(
		(revenue_full_price * 100.0 / (revenue_disc_price + revenue_full_price)) 
		,2
	)AS revenue_full_price_pct,

	discount_rate_pct
	
FROM base_profit2

























