WITH monthly_revenue AS 
(
    SELECT 
        o.order_id, 
        o.customer_id, 
        date_trunc('month', o.order_date)::date AS "Month", 
        oi.line_revenue
    FROM orders o
    JOIN order_items oi
        ON o.order_id = oi.order_id
    WHERE o.order_status = 'Completed'
),

monthly_summary AS 
(
    SELECT 
        "Month",
        TO_CHAR("Month", 'YYYY Mon')  AS month_label, 
        COUNT(DISTINCT customer_id) AS customer_count, 
        COUNT(DISTINCT order_id)    AS order_count, 
        SUM(line_revenue)           AS total_revenue
    FROM monthly_revenue
    GROUP BY "Month"
),

with_lag AS 
(
    SELECT
        *,
        LAG(total_revenue) OVER (ORDER BY "Month") AS prev_month_revenue
    FROM monthly_summary
)

SELECT
    "Month",
    month_label,
    customer_count,
    order_count,
    total_revenue,
    prev_month_revenue,

    total_revenue - prev_month_revenue AS mom_change,

    ROUND
	(
        CASE
            WHEN prev_month_revenue IS NULL OR prev_month_revenue = 0 
                THEN NULL
            ELSE (total_revenue - prev_month_revenue)*100.0 / prev_month_revenue
        END
    ,2
	) AS mom_growth_pct,

    ROUND
	(
        AVG(total_revenue) OVER 
		(
            ORDER BY "Month"
            ROWS BETWEEN 5 PRECEDING AND CURRENT ROW
        )
    	,2
	) AS revenue_6m_rolling_avg

FROM with_lag
ORDER BY "Month" ASC;