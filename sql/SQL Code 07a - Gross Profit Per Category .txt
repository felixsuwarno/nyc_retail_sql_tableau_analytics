WITH base_profit AS 
(
    SELECT
        o.order_id,
        o.order_date,
        DATE_TRUNC('month', order_date)::date AS month, 
        TO_CHAR(DATE_TRUNC('month', order_date), 'YYYY MON') AS month_label,
        o.sales_channel,
        o.order_status,
        c.segment,
        c.region,
        p.category,
        p.subcategory,

        oi.quantity,
        oi.list_price,
        oi.discount_pct,
        oi.net_price,
        oi.line_revenue AS net_revenue,

        -- Cost (COGS)
        (oi.quantity * p.unit_cost) AS cogs,

        -- Gross profit
        oi.line_revenue - (oi.quantity * p.unit_cost) AS gross_profit,

        -- Gross margin %
        ROUND(
            (
                (oi.line_revenue - (oi.quantity * p.unit_cost)) * 100.0
                / NULLIF(oi.line_revenue, 0)
            )
        , 2) AS gross_margin_pct,

        -- Pricing / discount metrics
        (oi.quantity * oi.list_price) AS full_price_revenue,
        (oi.quantity * oi.list_price) - oi.line_revenue AS discount_amount

    FROM orders o
    JOIN order_items oi 	ON o.order_id = oi.order_id
    JOIN products p     	ON oi.product_id = p.product_id
    LEFT JOIN customers c 	ON o.customer_id = c.customer_id
    WHERE o.order_status = 'Completed'
)

SELECT 
    month,
    month_label,
    category,
    SUM(gross_profit) AS gross_profit
FROM base_profit
GROUP BY month, month_label, category
ORDER BY month, month_label, category;