WITH monthly_summary AS 
(
    SELECT 
        DATE_TRUNC('month', o.order_date)::date AS "Month", 
        TO_CHAR(DATE_TRUNC('month', o.order_date)::date, 'YYYY MON') AS char_month,
        SUM(oi.line_revenue) AS total_revenue
    FROM orders o
    JOIN order_items oi
        ON o.order_id = oi.order_id
    WHERE o.order_status = 'Completed'
    GROUP BY "Month", char_month
    ORDER BY "Month" ASC
),

with_lag AS
(
    SELECT
        "Month",
        char_month,
        total_revenue,
        LAG(total_revenue) OVER (ORDER BY "Month") AS prev_month_revenue
    FROM monthly_summary
)

SELECT
    "Month",
    char_month,
    total_revenue,
    prev_month_revenue,
    total_revenue - prev_month_revenue AS mom_change,
    ROUND(
        CASE 
            WHEN prev_month_revenue IS NULL OR prev_month_revenue = 0 THEN NULL
            ELSE (total_revenue - prev_month_revenue) * 100.0 / prev_month_revenue
        END
    , 2) AS monthly_perc_change

FROM with_lag
ORDER BY "Month" ASC;