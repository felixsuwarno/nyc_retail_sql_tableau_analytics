WITH base_profit AS 
(
    SELECT
        o.order_id,
        DATE_TRUNC('month', order_date)::date AS month, 
        TO_CHAR(DATE_TRUNC('month', order_date), 'YYYY MON') AS month_label,
        c.segment,
        oi.line_revenue AS net_revenue,
        (oi.quantity * p.unit_cost) AS cogs,
        oi.line_revenue - (oi.quantity * p.unit_cost) AS gross_profit
    FROM orders o
    JOIN order_items oi 	ON o.order_id = oi.order_id
    JOIN products p     	ON oi.product_id = p.product_id
    LEFT JOIN customers c 	ON o.customer_id = c.customer_id
    WHERE o.order_status = 'Completed'
)

SELECT
    	month,
    	month_label,
    	segment,
    	SUM(gross_profit) AS total_gross_profit_segment,
    	COUNT(DISTINCT order_id) AS num_orders_in_segment,
	ROUND
	(
        	SUM(gross_profit) * 1.0 / COUNT(DISTINCT order_id)
    		, 2
	) AS avg_profit_per_order_segment
FROM base_profit
GROUP BY month, month_label, segment
ORDER BY month, segment;