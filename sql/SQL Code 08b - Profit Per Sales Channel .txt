WITH base_profit AS 
(
    SELECT
        o.order_id,
        o.order_date,
        DATE_TRUNC('month', order_date)::date AS month, 
        TO_CHAR(DATE_TRUNC('month', order_date), 'YYYY MON') AS month_label,
        o.sales_channel,
        o.order_status,
        c.segment,
        c.region,
        p.category,
        p.subcategory,

        oi.quantity,
        oi.list_price,
        oi.discount_pct,
        oi.net_price,
        oi.line_revenue AS net_revenue,

        -- Cost (COGS)
        (oi.quantity * p.unit_cost) AS cogs,

        -- Gross profit
        oi.line_revenue - (oi.quantity * p.unit_cost) AS gross_profit,

        -- Gross margin %
        ROUND
		(
            (
                (oi.line_revenue - (oi.quantity * p.unit_cost)) * 100.0
                / NULLIF(oi.line_revenue, 0)
            )
        	, 2
		) AS gross_margin_pct,

        -- Pricing / discount metrics
        (oi.quantity * oi.list_price) AS full_price_revenue,
        (oi.quantity * oi.list_price) - oi.line_revenue AS discount_amount

    FROM orders o
    JOIN order_items oi 	ON o.order_id = oi.order_id
    JOIN products p     	ON oi.product_id = p.product_id
    LEFT JOIN customers c 	ON o.customer_id = c.customer_id
    WHERE o.order_status = 'Completed'
),

profit_base2 AS
(
	SELECT 
		month, month_label, sales_channel, SUM(gross_profit) AS gross_profit_per_channel
	FROM base_profit
	GROUP BY month, month_label, sales_channel

),

profit_base3 AS
(
	SELECT 
		month, month_label, sales_channel, gross_profit_per_channel,
		SUM(gross_profit_per_channel) OVER
		(
			PARTITION BY month
		) AS gross_profit_monthly_total
	FROM profit_base2
)

SELECT 
	month, month_label, sales_channel, gross_profit_per_channel, 
	
	ROUND (gross_profit_per_channel *100.0 / gross_profit_monthly_total , 2)
	AS gross_profit_per_channel_pct,
	
	gross_profit_monthly_total
FROM profit_base3
ORDER BY month, sales_channel















