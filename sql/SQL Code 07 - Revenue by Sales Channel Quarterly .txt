WITH base1 AS
(
	SELECT 
		sales_channel, 
		DATE_TRUNC('month',order_date)::date AS month, 
		TO_CHAR(DATE_TRUNC('month',order_date)::date , 'YYYY MON') as month_label, 
		SUM(line_revenue) as revenue,
		COUNT(o.order_id) as order_count
	FROM orders o 
	JOIN order_items oi 
		ON o.order_id = oi.order_id 
	WHERE order_status = 'Completed' 
	GROUP BY sales_channel, month 
	ORDER BY sales_channel, month
),

base2 AS
(
	SELECT sales_channel, month, month_label, revenue,

		COALESCE
		(
			LAG(revenue) OVER 
			(	 
				PARTITION BY sales_channel 
				ORDER BY month 
			) 
			,0
		) AS revenue_lastmonth,

		order_count,

		COALESCE
		(
			LAG(order_count) OVER
			(
				PARTITION BY sales_channel
				ORDER BY month
			)
			,0
		)AS order_count_lastmonth
		

	FROM base1
)

SELECT sales_channel, month, month_label, revenue, revenue_lastmonth,

	ROUND
	(
		((revenue - revenue_lastmonth)*100.0)/NULLIF(revenue_lastmonth,0) 
		,2
	)
	AS rev_pct_change,
	
	ROUND
	(
		AVG(revenue) OVER
		(
			PARTITION BY sales_channel
			ORDER BY month
			ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
		)
		,2
	)
	AS rev_roll_3mth_avg,

	order_count,order_count_lastmonth,
	
	ROUND
	(
		(( order_count - order_count_lastmonth ) * 100.0) / NULLIF(order_count_lastmonth,0)
		,2
	)
	AS order_count_pct_change,

	ROUND
	(
		AVG(order_count) OVER
		(
			PARTITION BY sales_channel
			ORDER BY month
			ROWS BETWEEN 2 PRECEDING AND CURRENT ROW
		)
		,2
	)
	AS order_count_3mth_avg

FROM base2

