with base_table AS
(
	SELECT *
	FROM orders o
	JOIN order_items oi 
    	ON oi.order_id = o.order_id
	JOIN calendar cal 
    	ON cal.date = o.order_date
	WHERE o.order_status = 'Completed'
)

SELECT
	EXTRACT(YEAR FROM DATE_TRUNC('year', order_date)) AS year_num,

	SUM ( line_revenue ) AS total_revenue,

	SUM	
	( CASE WHEN is_us_holiday = 1 THEN line_revenue ELSE 0 END )
	AS us_holiday_rev,

	ROUND
	( 	SUM	
		( CASE WHEN is_us_holiday = 1 THEN line_revenue ELSE 0 END )*100.0 / SUM ( line_revenue )
		,2
	)
	AS perc_us_holiday,
	
	SUM ( CASE WHEN is_diwali_period = 1 THEN line_revenue ELSE 0 END )			
	AS  diwali_rev,

	ROUND
	( 	SUM	
		( CASE WHEN is_diwali_period = 1 THEN line_revenue ELSE 0 END )*100.0 / SUM ( line_revenue )
		,2
	)
	AS perc_diwali,

	SUM 
	( CASE WHEN is_lunar_new_year_period = 1 THEN line_revenue ELSE 0 END )			
	AS  chinese_newyear_rev,

	ROUND
	( 	SUM	
		( CASE WHEN is_lunar_new_year_period = 1 THEN line_revenue ELSE 0 END )*100.0 / SUM ( line_revenue )
		,2
	)
	AS perc_lunar_newyear,	

	SUM ( CASE WHEN is_eid_period = 1 THEN line_revenue ELSE 0 END )			
	AS  eid_rev,	

	ROUND
	( 	SUM	
		( CASE WHEN is_eid_period = 1 THEN line_revenue ELSE 0 END )*100.0 / SUM ( line_revenue )
		,2
	)
	AS perc_eid_rev,


	SUM ( CASE WHEN is_christmas_period = 1 THEN line_revenue ELSE 0 END )			
	AS  christmas_rev,

	ROUND
	( 	SUM	
		( CASE WHEN is_christmas_period = 1 THEN line_revenue ELSE 0 END )*100.0 / SUM ( line_revenue )
		,2
	)
	AS perc_christmas

FROM base_table
GROUP BY EXTRACT(YEAR FROM DATE_TRUNC('year', order_date))
ORDER BY year_num ASC;